<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de pricing | Automatizaciones</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #080c1a;
      --panel: #0f172a;
      --muted: #9fb1d0;
      --text: #e8ecf5;
      --accent: #7c3aed;
      --accent-2: #22d3ee;
      --border: rgba(255, 255, 255, 0.08);
      --success: #34d399;
      --danger: #f87171;
      --shadow: 0 20px 80px rgba(0, 0, 0, 0.45);
      --radius: 16px;
    }

    [data-theme="light"] {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --muted: #4b5563;
      --text: #0f172a;
      --accent: #7c3aed;
      --accent-2: #22c55e;
      --border: rgba(0, 0, 0, 0.08);
      --success: #16a34a;
      --danger: #dc2626;
      --shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Manrope', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.12), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(34, 211, 238, 0.12), transparent 25%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 32px 64px;
    }

    h1, h2, h3, .metric-value {
      font-family: 'Space Grotesk', 'Manrope', system-ui, sans-serif;
      letter-spacing: -0.01em;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(12px);
      padding: 12px;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 12px;
      color: var(--muted);
    }

    .brand h1 {
      margin: 0;
      font-size: 28px;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.9), rgba(34, 211, 238, 0.9));
      color: #0b0f1c;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      box-shadow: var(--shadow);
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      box-shadow: none;
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .card h3 {
      margin: 0 0 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 16px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
    }

    .help-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
      position: relative;
      background: rgba(255, 255, 255, 0.05);
    }

    .help-icon::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      bottom: 130%;
      transform: translateX(-50%);
      min-width: 200px;
      max-width: 260px;
      background: #0b1224;
      color: var(--text);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease;
      box-shadow: var(--shadow);
      font-size: 12px;
      line-height: 1.4;
      z-index: 10;
    }

    .help-icon:hover::after {
      opacity: 1;
    }

    input[type="number"], textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      color: var(--text);
      font-size: 15px;
    }

    input[type="number"]:focus, textarea:focus {
      outline: 1px solid var(--accent-2);
      border-color: rgba(34, 211, 238, 0.5);
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .scenario-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .chip.active {
      border-color: rgba(124, 58, 237, 0.6);
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.24), rgba(34, 211, 238, 0.18));
    }

    .scenario-note {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
      line-height: 1.4;
    }

    .results-hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .metric-card {
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
    }

    .metric-label {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
    }

    .metric-sub {
      margin-top: 4px;
      font-size: 13px;
      color: var(--muted);
    }

    .mini-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .scenario-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .scenario-card {
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
    }

    .scenario-card h4 {
      margin: 0 0 6px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(124, 58, 237, 0.12);
      color: var(--text);
      font-size: 12px;
      border: 1px solid var(--border);
    }

    .summary-box {
      margin-top: 12px;
      padding: 14px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.02);
      border: 1px dashed var(--border);
      font-size: 14px;
      color: var(--text);
      white-space: pre-line;
    }

    .inline-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(52, 211, 153, 0.1);
      color: var(--success);
      border: 1px solid rgba(52, 211, 153, 0.3);
      font-size: 12px;
      font-weight: 700;
    }

    .tag.danger {
      background: rgba(248, 113, 113, 0.12);
      color: var(--danger);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .paymode-toggle {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    .paymode-toggle button {
      background: transparent;
      border: none;
      color: var(--text);
      padding: 10px 14px;
      box-shadow: none;
      border-right: 1px solid var(--border);
    }

    .paymode-toggle button:last-child { border-right: none; }

    .paymode-toggle button.active {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.35), rgba(34, 211, 238, 0.25));
      color: var(--text);
    }

    .contract-box {
      margin-top: 12px;
      padding: 14px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.02);
      border: 1px dashed var(--border);
      font-size: 14px;
      color: var(--text);
      white-space: pre-wrap;
    }

    .contract-editor {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      margin-top: 8px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
    }

    @media (max-width: 960px) {
      body { padding: 20px; }
      .layout { flex-direction: column; }
      .topbar { align-items: flex-start; }
    }

    @media print {
      body { background: white; color: #111; padding: 0; }
      .topbar, .actions, .inline-actions, .scenario-chips { display: none !important; }
      .page { max-width: none; padding: 0; }
      .card { box-shadow: none; border: 1px solid #ddd; background: #fff; }
      button { display: none; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div class="brand">
        <span class="eyebrow">Automatizaciones</span>
        <h1>Calculadora de pricing</h1>
        <div style="color: var(--muted); font-size: 14px;">Basada en ahorro, captura de valor y riesgo con escenarios rápidos.</div>
      </div>
      <div class="actions">
        <button class="secondary" id="copy-summary">Copiar resumen</button>
        <button class="secondary" id="send-email">Enviar por email</button>
        <button id="print-contract">Imprimir / contrato</button>
        <div class="pill-toggle" id="theme-toggle" role="button" aria-label="Cambiar tema">
          <span id="theme-label">Auto</span>
        </div>
        <div class="pill-toggle" style="padding:6px 10px;">
          <label for="currency" style="font-size:12px; color:var(--muted); margin-right:4px;">Moneda</label>
          <select id="currency" style="background:transparent; border:none; color:var(--text); font-weight:700;">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="DOP">DOP</option>
          </select>
        </div>
      </div>
    </header>

    <div class="layout">
      <section class="card">
        <h3>Inputs clave</h3>
        <div class="scenario-note" style="margin-bottom:10px;">
          ¿Cómo funciona? Base = parámetros estándar; Conservador = margen/captura reducidos, menor riesgo; Agresivo = margen/captura altos y mayor riesgo. Pago único desactiva la mensualidad. Usa ejemplos rápidos para precargar valores.
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="secondary" type="button" data-prefill="saas">Ejemplo SaaS</button>
            <button class="secondary" type="button" data-prefill="ecom">Ejemplo eCommerce</button>
            <button class="secondary" type="button" data-prefill="ops">Ejemplo Ops</button>
          </div>
        </div>
        <div class="grid two">
          <label>
            <div class="label-row">
              Horas ahorradas por semana
              <span class="help-icon" data-tip="Horas que el cliente deja de dedicar por semana gracias a la automatización.">?</span>
            </div>
            <input type="number" id="hoursWeek" min="0" step="0.1" value="8" />
          </label>
          <label>
            <div class="label-row">
              Coste por hora del cliente
              <span class="help-icon" data-tip="Tarifa por hora del equipo/cliente (USD) para valorar el ahorro de tiempo.">?</span>
            </div>
            <input type="number" id="clientRate" min="0" step="1" value="45" />
          </label>
          <label>
            <div class="label-row">
              Beneficio incremental mensual
              <span class="help-icon" data-tip="Ingresos adicionales mensuales esperados (ventas, retención, etc.).">?</span>
            </div>
            <input type="number" id="incremental" min="0" step="10" value="300" />
          </label>
          <label>
            <div class="label-row">
              Coste mensual de herramientas
              <span class="help-icon" data-tip="Licencias y suscripciones mensuales (p. ej., n8n cloud, email, CRM).">?</span>
            </div>
            <input type="number" id="tools" min="0" step="10" value="60" />
          </label>
          <label>
            <div class="label-row">
              Horas de implementación (setup)
              <span class="help-icon" data-tip="Horas totales para configurar la solución (diseño, integraciones, QA).">?</span>
            </div>
            <input type="number" id="setupHours" min="0" step="1" value="18" />
          </label>
          <label>
            <div class="label-row">
              Horas de mantenimiento / mes
              <span class="help-icon" data-tip="Horas mensuales de soporte y ajustes para mantener la automatización.">?</span>
            </div>
            <input type="number" id="maintenanceHours" min="0" step="0.5" value="4" />
          </label>
          <label>
            <div class="label-row">
              Tu tarifa por hora
              <span class="help-icon" data-tip="Tu tarifa o costo interno por hora.">?</span>
            </div>
            <input type="number" id="myRate" min="0" step="1" value="75" />
          </label>
          <label>
            <div class="label-row">
              Margen deseado (%)
              <span class="help-icon" data-tip="Markup que quieres aplicar sobre tus costes (ej. 40 = +40%).">?</span>
            </div>
            <input type="number" id="margin" min="0" step="1" value="40" />
          </label>
          <label>
            <div class="label-row">
              % de valor capturado
              <span class="help-icon" data-tip="Porcentaje del valor generado que quieres capturar como precio.">?</span>
            </div>
            <input type="number" id="capture" min="0" step="1" value="18" />
          </label>
          <label>
            <div class="label-row">
              Factor de riesgo / complejidad
              <span class="help-icon" data-tip="Multiplicador por complejidad o riesgo (1.0 = normal, >1 = más exigente).">?</span>
            </div>
            <input type="number" id="risk" min="0.5" step="0.05" value="1.0" />
          </label>
          <label>
            <div class="label-row">
              Payback objetivo (meses)
              <span class="help-icon" data-tip="Meses en los que el cliente busca recuperar la inversión.">?</span>
            </div>
            <input type="number" id="paybackTarget" min="1" step="0.5" value="4" />
          </label>
          <label>
            <div class="label-row">
              Nombre del cliente (opcional)
              <span class="help-icon" data-tip="Se usará en el resumen y el contrato al imprimir/enviar.">?</span>
            </div>
            <input type="text" id="clientName" placeholder="Ej: ACME Inc." />
          </label>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3>Notas de alcance</h3>
          <textarea id="notes" placeholder="Notas clave para la propuesta">Automatización n8n: onboarding + follow-up, integraciones básicas con CRM y email. Monitor + alertas semanales.</textarea>
        </div>
      </section>

      <section class="card">
        <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;">
          <div>
            <div class="scenario-chips">
              <div class="chip active" data-scenario="base">Base</div>
              <div class="chip" data-scenario="conservative">Conservador</div>
              <div class="chip" data-scenario="aggressive">Agresivo</div>
            </div>
            <div class="scenario-note">Base = parámetros estándar; Conservador = margen/captura reducidos, menor riesgo; Agresivo = margen/captura altos y mayor riesgo.</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            <span style="color:var(--muted); font-size:12px;">Modo de cobro</span>
            <div class="paymode-toggle">
              <button type="button" data-paymode="subscription" class="active">Mantenimiento mensual</button>
              <button type="button" data-paymode="one-time">Pago único</button>
            </div>
          </div>
        </div>

        <div class="results-hero">
          <div class="metric-card">
            <div class="metric-label">Setup recomendado</div>
            <div class="metric-value" id="setupOut">—</div>
            <div class="metric-sub" id="setupBase">Coste base: —</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Mensual recomendado</div>
            <div class="metric-value" id="monthlyOut">—</div>
            <div class="metric-sub" id="monthlyDetail">Coste vs valor: —</div>
          </div>
        </div>

        <div class="mini-metrics">
          <div class="metric-card">
            <div class="metric-label">Payback estimado</div>
            <div class="metric-value" id="paybackOut">—</div>
            <div class="metric-sub" id="paybackGap">Objetivo: —</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">ROI a 12 meses</div>
            <div class="metric-value" id="roiOut">—</div>
            <div class="metric-sub" id="roiDetail">—</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Valor mensual generado</div>
            <div class="metric-value" id="valueOut">—</div>
            <div class="metric-sub" id="savingsOut">Ahorro + beneficio</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Coste mensual + setup</div>
            <div class="metric-value" id="costsOut">—</div>
            <div class="metric-sub" id="costsDetail">Mantenimiento + herramientas</div>
          </div>
        </div>

        <div class="scenario-cards" id="scenarioCards"></div>

        <div class="summary-box" id="summaryBox"></div>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px;">
          <strong style="color:var(--muted); font-size:13px;">Presupuesto para el cliente (editable)</strong>
          <span style="color:var(--muted); font-size:12px;">Este texto se actualiza con los cálculos; puedes ajustarlo antes de enviar/imprimir.</span>
        </div>
        <div class="contract-box" id="contractBox" contenteditable="true"></div>
        <div class="inline-actions">
          <span class="tag" id="healthTag"></span>
        </div>
      </section>
    </div>
  </div>

  <script>
    const inputs = {
      hoursWeek: document.getElementById('hoursWeek'),
      clientRate: document.getElementById('clientRate'),
      incremental: document.getElementById('incremental'),
      tools: document.getElementById('tools'),
      setupHours: document.getElementById('setupHours'),
      maintenanceHours: document.getElementById('maintenanceHours'),
      myRate: document.getElementById('myRate'),
      margin: document.getElementById('margin'),
      capture: document.getElementById('capture'),
      risk: document.getElementById('risk'),
      paybackTarget: document.getElementById('paybackTarget'),
      notes: document.getElementById('notes'),
      clientName: document.getElementById('clientName')
    };

    const scenarioButtons = Array.from(document.querySelectorAll('.chip[data-scenario]'));
    const paymodeButtons = Array.from(document.querySelectorAll('[data-paymode]'));
    const scenarioDefs = {
      base: { label: 'Base', multipliers: { margin: 1, capture: 1, risk: 1 } },
      conservative: { label: 'Conservador', multipliers: { margin: 0.65, capture: 0.6, risk: 0.95 } },
      aggressive: { label: 'Agresivo', multipliers: { margin: 1.25, capture: 1.35, risk: 1.2 } }
    };

    let currency = localStorage.getItem('calc_currency') || 'USD';
    let themeMode = localStorage.getItem('calc_theme') || 'auto';

    function makeFmtCurrency() {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency, maximumFractionDigits: 0 });
    }

    let fmtCurrency = makeFmtCurrency();
    const fmtPercent = new Intl.NumberFormat('es-ES', { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 1 });
    const fmtNum = new Intl.NumberFormat('es-ES', { maximumFractionDigits: 1 });

    let currentScenario = 'base';
    let paymentMode = 'subscription'; // 'subscription' | 'one-time'

    function val(inputEl) {
      const n = Number(inputEl.value);
      return Number.isFinite(n) ? n : 0;
    }

    function calculate(base, multipliers) {
      const margin = (base.margin / 100) * multipliers.margin;
      const capture = (base.capture / 100) * multipliers.capture;
      const risk = base.risk * multipliers.risk;

      const hoursMonth = base.hoursWeek * 4.33;
      const savings = hoursMonth * base.clientRate;
      const valueMonthly = savings + base.incremental;
      const costMonthly = base.maintenanceHours * base.myRate + base.tools;
      const costSetup = base.setupHours * base.myRate;

      const setupRecommended = costSetup * (1 + margin) * risk;
      const monthlyCostBased = costMonthly * (1 + margin) * risk;
      const monthlyValueBased = valueMonthly * capture;
      const monthlyRecommended = Math.max(monthlyCostBased, monthlyValueBased);

      const denom = valueMonthly - monthlyRecommended;
      const paybackMonths = denom > 0 ? setupRecommended / denom : null;

      const totalCostYear = setupRecommended + (monthlyRecommended * 12);
      const roi12 = totalCostYear > 0 ? (valueMonthly * 12 - totalCostYear) / totalCostYear : null;

      return {
        setupRecommended,
        monthlyRecommended,
        paybackMonths,
        roi12,
        hoursMonth,
        savings,
        valueMonthly,
        costMonthly,
        costSetup,
        margin,
        capture,
        risk
      };
    }

    function updateUI() {
      const baseInputs = {
        hoursWeek: val(inputs.hoursWeek),
        clientRate: val(inputs.clientRate),
        incremental: val(inputs.incremental),
        tools: val(inputs.tools),
        setupHours: val(inputs.setupHours),
        maintenanceHours: val(inputs.maintenanceHours),
        myRate: val(inputs.myRate),
        margin: val(inputs.margin),
        capture: val(inputs.capture),
        risk: val(inputs.risk),
        paybackTarget: val(inputs.paybackTarget)
      };

      const selectedScenario = scenarioDefs[currentScenario];
      const result = calculate(baseInputs, selectedScenario.multipliers);

      const monthlyFinal = paymentMode === 'one-time' ? 0 : result.monthlyRecommended;
      const denom = result.valueMonthly - monthlyFinal;
      const payback = denom > 0 ? result.setupRecommended / denom : null;
      const totalCostYear = result.setupRecommended + (monthlyFinal * 12);
      const roi12 = totalCostYear > 0 ? (result.valueMonthly * 12 - totalCostYear) / totalCostYear : null;

      document.getElementById('setupOut').textContent = fmtCurrency.format(result.setupRecommended);
      document.getElementById('monthlyOut').textContent = paymentMode === 'one-time' ? '— (pago único)' : fmtCurrency.format(monthlyFinal);
      document.getElementById('setupBase').textContent = `Coste base: ${fmtCurrency.format(result.costSetup)}`;
      document.getElementById('monthlyDetail').textContent = paymentMode === 'one-time'
        ? 'Modo pago único: no se factura mensual.'
        : `Coste puro: ${fmtCurrency.format(result.costMonthly)} · Valor capturado: ${fmtCurrency.format(result.valueMonthly * result.capture)}`;
      document.getElementById('valueOut').textContent = fmtCurrency.format(result.valueMonthly);
      document.getElementById('savingsOut').textContent = `${fmtCurrency.format(result.savings)} ahorro + ${fmtCurrency.format(baseInputs.incremental)} extra`;
      document.getElementById('costsOut').textContent = fmtCurrency.format(result.costMonthly + result.costSetup / 12);
      document.getElementById('costsDetail').textContent = `Mantenimiento: ${fmtCurrency.format(result.costMonthly - baseInputs.tools)} · Herramientas: ${fmtCurrency.format(baseInputs.tools)}`;

      const paybackTarget = baseInputs.paybackTarget;
      const paybackText = payback ? `${fmtNum.format(payback)} meses` : 'N/A';
      document.getElementById('paybackOut').textContent = paybackText;
      document.getElementById('paybackGap').textContent = payback ? `Objetivo: ${paybackTarget} meses` : 'Objetivo: no alcanzable con estos datos';

      const roiText = roi12 != null ? fmtPercent.format(roi12) : 'N/A';
      document.getElementById('roiOut').textContent = roiText;
      document.getElementById('roiDetail').textContent = `Costo total año: ${fmtCurrency.format(totalCostYear)}`;

      renderScenarios(baseInputs);
      renderSummary(selectedScenario.label, { ...result, monthlyRecommended: monthlyFinal, paybackMonths: payback, roi12 });
      renderHealth({ ...result, paybackMonths: payback }, paybackTarget);
    }

    function renderScenarios(baseInputs) {
      const container = document.getElementById('scenarioCards');
      container.innerHTML = '';
      Object.entries(scenarioDefs).forEach(([key, def]) => {
        const res = calculate(baseInputs, def.multipliers);
        const monthlyFinal = paymentMode === 'one-time' ? 0 : res.monthlyRecommended;
        const totalCostYear = res.setupRecommended + (monthlyFinal * 12);
        const roiDisplay = totalCostYear > 0 ? (res.valueMonthly * 12 - totalCostYear) / totalCostYear : null;
        const card = document.createElement('div');
        card.className = 'scenario-card';
        card.innerHTML = `
          <h4>${def.label} ${key === currentScenario ? '<span class="pill">Seleccionado</span>' : ''}</h4>
          <div class="metric-sub">Margen ${(baseInputs.margin * def.multipliers.margin).toFixed(1)}% · Captura ${(baseInputs.capture * def.multipliers.capture).toFixed(1)}% · Riesgo ${res.risk.toFixed(2)}x</div>
          <div class="metric-value" style="font-size:22px;">${fmtCurrency.format(res.setupRecommended)}</div>
          <div class="metric-sub">Setup recomendado</div>
          <div class="metric-value" style="font-size:20px;">${paymentMode === 'one-time' ? '—' : fmtCurrency.format(monthlyFinal)}</div>
          <div class="metric-sub">${paymentMode === 'one-time' ? 'Pago único (sin mensual)' : 'Mensual recomendado'}</div>
          <div class="metric-sub" style="margin-top:6px;">ROI 12m: ${roiDisplay != null ? fmtPercent.format(roiDisplay) : 'N/A'}</div>
        `;
        container.appendChild(card);
      });
    }

    function renderSummary(label, res) {
      const payback = res.paybackMonths ? `${fmtNum.format(res.paybackMonths)} meses` : 'No alcanzable con los supuestos actuales';
      const roi = res.roi12 != null ? fmtPercent.format(res.roi12) : 'N/A';
      const client = inputs.clientName.value.trim() || 'Cliente';
      const summary = [
        `Escenario: ${label} · Modo: ${paymentMode === 'one-time' ? 'Pago único' : 'Mantenimiento mensual'}`,
        `Cliente: ${client}`,
        `Setup recomendado: ${fmtCurrency.format(res.setupRecommended)}`,
        `Mensual recomendado: ${paymentMode === 'one-time' ? '—' : fmtCurrency.format(res.monthlyRecommended)}`,
        `Payback estimado: ${payback}`,
        `ROI 12m: ${roi}`,
        `Valor mensual generado: ${fmtCurrency.format(res.valueMonthly)} (ahorro ${fmtCurrency.format(res.savings)} + extra ${fmtCurrency.format(val(inputs.incremental))})`,
        `Coste mensual (mantenimiento + herramientas): ${fmtCurrency.format(res.costMonthly)}`,
        '',
        `Notas: ${inputs.notes.value.trim() || '—'}`
      ].join('\n');
      document.getElementById('summaryBox').textContent = summary;
      document.getElementById('contractBox').textContent = buildContractText(label, res);
    }

    function buildContractText(label, res) {
      const client = inputs.clientName.value.trim() || 'Cliente';
      const notes = inputs.notes.value.trim() || 'Alcance resumido no especificado.';
      const modeText = paymentMode === 'one-time'
        ? `Pago único por implementación: ${fmtCurrency.format(res.setupRecommended)}`
        : `Inversión propuesta: Setup ${fmtCurrency.format(res.setupRecommended)} + Mensual ${fmtCurrency.format(res.monthlyRecommended)}`;
      const paybackText = res.paybackMonths ? `${fmtNum.format(res.paybackMonths)} meses` : 'No alcanzable con los datos actuales';
      const roiText = res.roi12 != null ? fmtPercent.format(res.roi12) : 'N/A';
      const today = new Date().toLocaleDateString('es-ES');
      return [
        `Fecha: ${today}`,
        `Presupuesto para: ${client}`,
        ``,
        `Resumen ejecutivo`,
        `- Inversión propuesta: ${modeText}`,
        `- ROI estimado a 12 meses: ${roiText}`,
        `- Payback estimado: ${paybackText}`,
        `- Ahorro mensual de tiempo: ${fmtNum.format(res.hoursMonth)} horas (~${fmtCurrency.format(res.savings)} de valor)`,
        `- Valor mensual generado (ahorro + incremento): ${fmtCurrency.format(res.valueMonthly)}`,
        ``,
        `Beneficios clave al implementar:`,
        `- Menos horas operativas y menor error humano gracias a automatización n8n.`,
        `- Más velocidad en onboarding/seguimiento → mejor conversión y retención.`,
        `- Visibilidad y alertas automáticas para decisiones más rápidas.`,
        ``,
        `Alcance resumido:`,
        `${notes}`,
        ``,
        `Condiciones:`,
        `- Facturación en ${currency}. Cambios fuera de alcance se cotizan aparte.`,
        `- Vigencia de la oferta: 15 días.`,
        `- Forma de pago: 50% al inicio y 50% al entregar (o pago completo si aplica pago único).`,
        ``,
        `Próximo paso: confirma este presupuesto para agendar kickoff y activar la implementación.`
      ].join('\n');
    }

    function renderHealth(res, target) {
      const tag = document.getElementById('healthTag');
      const gap = res.paybackMonths && target ? res.paybackMonths - target : null;
      if (!res.paybackMonths) {
        tag.textContent = 'Payback no alcanzable con el valor actual';
        tag.className = 'tag danger';
        return;
      }
      if (gap <= 0) {
        tag.textContent = `Payback en ${fmtNum.format(res.paybackMonths)} meses (<= objetivo)`;
        tag.className = 'tag';
      } else {
        tag.textContent = `Payback ${fmtNum.format(gap)} meses por encima del objetivo`;
        tag.className = 'tag danger';
      }
    }

    scenarioButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        currentScenario = btn.dataset.scenario;
        scenarioButtons.forEach(b => b.classList.toggle('active', b === btn));
        updateUI();
      });
    });

    paymodeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        paymentMode = btn.dataset.paymode;
        paymodeButtons.forEach(b => b.classList.toggle('active', b === btn));
        updateUI();
      });
    });

    Object.values(inputs).forEach(el => el.addEventListener('input', () => {
      persistInputs();
      updateUI();
    }));

    document.getElementById('print-contract').addEventListener('click', () => window.print());

    document.getElementById('send-email').addEventListener('click', () => {
      const text = document.getElementById('contractBox').textContent;
      const subject = `Presupuesto automatización - ${inputs.clientName.value.trim() || 'Cliente'}`;
      const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
      window.location.href = mailto;
    });

    document.getElementById('copy-summary').addEventListener('click', async () => {
      const text = document.getElementById('summaryBox').textContent;
      try {
        await navigator.clipboard.writeText(text);
        const btn = document.getElementById('copy-summary');
        const prev = btn.textContent;
        btn.textContent = 'Copiado';
        setTimeout(() => { btn.textContent = prev; }, 1200);
      } catch (_) {
        alert('No se pudo copiar. Revisa permisos del navegador.');
      }
    });

    document.getElementById('currency').addEventListener('change', (e) => {
      currency = e.target.value;
      localStorage.setItem('calc_currency', currency);
      fmtCurrency = makeFmtCurrency();
      updateUI();
    });

    document.querySelectorAll('[data-prefill]').forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.prefill;
        const presets = {
          saas: { hoursWeek: 10, clientRate: 55, incremental: 600, tools: 80, setupHours: 24, maintenanceHours: 6, myRate: 85, margin: 45, capture: 20, risk: 1.1, paybackTarget: 5 },
          ecom: { hoursWeek: 8, clientRate: 40, incremental: 900, tools: 120, setupHours: 18, maintenanceHours: 5, myRate: 70, margin: 40, capture: 18, risk: 1.0, paybackTarget: 4 },
          ops: { hoursWeek: 12, clientRate: 35, incremental: 0, tools: 50, setupHours: 16, maintenanceHours: 3, myRate: 65, margin: 35, capture: 15, risk: 0.95, paybackTarget: 3 }
        };
        const preset = presets[type];
        Object.entries(preset).forEach(([k, v]) => { inputs[k].value = v; });
        persistInputs();
        updateUI();
      });
    });

    const themeToggle = document.getElementById('theme-toggle');
    const themeLabel = document.getElementById('theme-label');

    function applyTheme(mode) {
      const hour = new Date().getHours();
      const autoPrefersLight = hour >= 7 && hour < 19;
      const final = mode === 'auto' ? (autoPrefersLight ? 'light' : 'dark') : mode;
      document.documentElement.dataset.theme = final === 'light' ? 'light' : 'dark';
      themeLabel.textContent = mode === 'auto' ? 'Auto' : (final === 'light' ? 'Día' : 'Noche');
    }

    themeToggle.addEventListener('click', () => {
      if (themeMode === 'auto') themeMode = 'light';
      else if (themeMode === 'light') themeMode = 'dark';
      else themeMode = 'auto';
      localStorage.setItem('calc_theme', themeMode);
      applyTheme(themeMode);
    });

    function persistInputs() {
      const payload = {};
      Object.keys(inputs).forEach(k => {
        payload[k] = inputs[k].value;
      });
      localStorage.setItem('calc_inputs', JSON.stringify(payload));
    }

    function restoreInputs() {
      const raw = localStorage.getItem('calc_inputs');
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        Object.entries(data).forEach(([k, v]) => {
          if (inputs[k]) inputs[k].value = v;
        });
      } catch (_) { /* ignore */ }
    }

    restoreInputs();
    document.getElementById('currency').value = currency;
    applyTheme(themeMode);
    updateUI();
  </script>
</body>
</html>
